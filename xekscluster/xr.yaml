apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: x-eks-cluster
spec:
  compositeTypeRef:
    apiVersion: consumable.trustbank.sg/v1alpha1
    kind: xEksCluster
  patchSets:
  - name: region-patchset
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: "spec.location"
      toFieldPath: "spec.forProvider.region"
      transforms:
        - type: map
          map: 
            HKG: "ap-east-1"
            SGP: "ap-southeast-1"
            SYD: "ap-southeast-2"
            JKT: "ap-southeast-3"
  - name: vpcid-patchset
    patches:
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-vpc"
      toFieldPath: spec.forProvider.vpcIdRef.name
  resources:
  - name: x-iam-eks
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      metadata:
        name: xplane-eks-iam
      spec:
        deletionPolicy: Delete
        forProvider:
          assumeRolePolicy: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": "eks.amazonaws.com"
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            }
          managedPolicyArns:
          - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
          tags:
            Name: xplane-eks-iam
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-iam"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-iam"
      toFieldPath: spec.forProvider.tags.Name
  - name: x-securitygroup-eks-cluster
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroup
      metadata:
        name: xplane-eks-sg-cluster
      spec:
        deletionPolicy: Delete
        forProvider:
          name: xplane-eks-sg-cluster
          description: "Security Group for EKS Control Plane"
          region: ap-southeast-1
          vpcIdRef:
            name: xplane-vpc
          tags:
            Name: xplane-eks-sg-cluster
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: PatchSet
      patchSetName: region-patchset
      patchSetName: vpcid-patchset
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-cluster"
      toFieldPath: spec.forProvider.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-cluster"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-cluster"
      toFieldPath: spec.forProvider.tags.Name
  - name: x-sg-ingress-eks-cluster
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupIngressRule
      metadata:
        name: xplane-eks-sg-ingress-cluster
      spec:
        deletionPolicy: Delete
        forProvider:
          description: "Allow woker node to communicate with cluster API server"
          region: ap-southeast-1
          fromPort: 443
          toPort: 443
          ipProtocol: tcp
          referencedSecurityGroupIdRef:
            name: xplane-eks-sg-node
          securityGroupIdRef:
            name: xplane-eks-sg-cluster
          tags:
            Name: xplane-eks-sg-ingress-cluster
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: PatchSet
      patchSetName: region-patchset
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-ingress-cluster"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-ingress-cluster"
      toFieldPath: spec.forProvider.tags.Name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-cluster"
      toFieldPath: spec.forProvider.securityGroupIdRef.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-node"
      toFieldPath: spec.forProvider.referencedSecurityGroupIdRef.name
  - name: x-sg-egress-eks-cluster
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupEgressRule
      metadata:
        name: xplane-eks-sg-egress-cluster
      spec:
        deletionPolicy: Delete
        forProvider:
          description: "Allow woker node to communicate with cluster API server"
          region: ap-southeast-1
          fromPort: 1024
          toPort: 65535
          ipProtocol: tcp
          referencedSecurityGroupIdRef:
            name: xplane-eks-sg-node
          securityGroupIdRef:
            name: xplane-eks-sg-cluster
          tags:
            Name: xplane-eks-sg-egress-cluster
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: PatchSet
      patchSetName: region-patchset
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-egress-cluster"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-egress-cluster"
      toFieldPath: spec.forProvider.tags.Name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-cluster"
      toFieldPath: spec.forProvider.securityGroupIdRef.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-node"
      toFieldPath: spec.forProvider.referencedSecurityGroupIdRef.name
  - name: x-securitygroup-eks-node
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroup
      metadata:
        name: xplane-eks-sg-node
      spec:
        deletionPolicy: Delete
        forProvider:
          name: xplane-eks-sg-node
          description: "Security Group for EKS Nodes"
          region: ap-southeast-1
          vpcIdRef:
            name: xplane-vpc
          tags:
            Name: xplane-eks-sg-node
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: PatchSet
      patchSetName: region-patchset
      patchSetName: vpcid-patchset
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-node"
      toFieldPath: spec.forProvider.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-node"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-node"
      toFieldPath: spec.forProvider.tags.Name
  - name: x-sg-ingress-eks-node-to-node
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupIngressRule
      metadata:
        name: xplane-eks-sg-ingress-node-to-node
      spec:
        deletionPolicy: Delete
        forProvider:
          description: "Allow woker node to communicate with each others"
          region: ap-southeast-1
          ipProtocol: "-1"
          referencedSecurityGroupIdRef:
            name: x-securitygroup-eks-node
          securityGroupIdRef:
            name: x-securitygroup-eks-node
          tags:
            Name: xplane-eks-sg-ingress-node-to-node
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: PatchSet
      patchSetName: region-patchset
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-ingress-node-to-node"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-ingress-node-to-node"
      toFieldPath: spec.forProvider.tags.Name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-node"
      toFieldPath: spec.forProvider.securityGroupIdRef.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-node"
      toFieldPath: spec.forProvider.referencedSecurityGroupIdRef.name
  - name: x-sg-ingress-eks-cluster-to-node
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupIngressRule
      metadata:
        name: xplane-eks-sg-ingress-cluster-to-node
      spec:
        deletionPolicy: Delete
        forProvider:
          description: "Allow Control Plane to communicate with Workers"
          region: ap-southeast-1
          fromPort: 1025
          toPort: 65535
          ipProtocol: tcp
          referencedSecurityGroupIdRef:
            name: xplane-eks-sg-cluster
          securityGroupIdRef:
            name: xplane-eks-sg-node
          tags:
            Name: xplane-eks-sg-ingress-node-to-node
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: PatchSet
      patchSetName: region-patchset
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-ingress-cluster-to-node"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-ingress-cluster-to-node"
      toFieldPath: spec.forProvider.tags.Name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-node"
      toFieldPath: spec.forProvider.securityGroupIdRef.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-cluster"
      toFieldPath: spec.forProvider.referencedSecurityGroupIdRef.name
  - name: x-sg-egress-eks-node
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupEgressRule
      metadata:
        name: xplane-eks-sg-egress-node
      spec:
        deletionPolicy: Delete
        forProvider:
          description: "Allow woker node to communicate out"
          region: ap-southeast-1
          cidrIpv4: 0.0.0.0/0
          ipProtocol: "-1"
          securityGroupIdRef:
            name: xplane-eks-sg-node
          tags:
            Name: xplane-eks-sg-egress-node
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: PatchSet
      patchSetName: region-patchset
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-egress-node"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-egress-node"
      toFieldPath: spec.forProvider.tags.Name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-sg-node"
      toFieldPath: spec.forProvider.securityGroupIdRef.name
  - name: x-eks-cluster
    base:
      apiVersion: eks.aws.upbound.io/v1beta1
      kind: Cluster
      metadata:
        name: xplane-eks-cluster
      spec:
        deletionPolicy: Delete
        forProvider:
          region: ap-southeast-1
          roleArnRef:
            name: xplane-eks-iam
          version: "1.29"
          vpcConfig:
          - endpointPrivateAccess: true
            endpointPublicAccess: true
            subnetIdRefs:
            - name: xplane-private-subnet-1a
            - name: xplane-private-subnet-1b
            - name: xplane-private-subnet-1c
            securityGroupIdSelector:
              matchControllerRef: true
          tags:
            Name: xplane-eks-cluster
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: PatchSet
      patchSetName: region-patchset
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-cluster"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-cluster"
      toFieldPath: spec.forProvider.tags.Name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-iam"
      toFieldPath: spec.forProvider.roleArnRef.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-private-subnet-1a"
      toFieldPath: spec.forProvider.vpcConfig[0].subnetIdRefs[0].name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-private-subnet-1b"
      toFieldPath: spec.forProvider.vpcConfig[0].subnetIdRefs[1].name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-private-subnet-1c"
      toFieldPath: spec.forProvider.vpcConfig[0].subnetIdRefs[2].name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.identity[0].oidc[0].issuer
      toFieldPath: status.oidcIssuer
      transforms:
      - type: string
        string:
          type: TrimPrefix
          trim: 'https://'
  - name: x-oidc-provider
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: OpenIDConnectProvider
      metadata:
        name: xplane-oidc-provider
      spec:
        deletionPolicy: Delete
        forProvider:
          clientIdList:
          - sts.amazonaws.com
          thumbprintList:
          - 9e99a48a9960b14926bb7f3b02e22da2b0ab7280
          tags:
            Name: xplane-oidc-provider
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-oidc-provider"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-oidc-provider"
      toFieldPath: spec.forProvider.tags.Name
    # - type: FromCompositeFieldPath
    #   fromFieldPath: status.oidcIssuer
    #   toFieldPath: spec.forProvider.url
    #   policy:
    #     fromFieldPath: Required
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: status.oidcIssuer
        strategy: string
        string:
          fmt: "https://%s"
      toFieldPath: spec.forProvider.url
      policy:
        fromFieldPath: Required
  - name: x-iam-fargate-pod
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      metadata:
        name: xplane-fargate-pod-iam
      spec:
        deletionPolicy: Delete
        forProvider:
          assumeRolePolicy: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": "eks-fargate-pods.amazonaws.com"
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            }
          managedPolicyArns:
          - arn:aws:iam::aws:policy/AmazonEKSFargatePodExecutionRolePolicy
          tags:
            Name: xplane-fargate-pod-iam
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-fargate-pod-iam"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-fargate-pod-iam"
      toFieldPath: spec.forProvider.tags.Name
  - name: x-fargate-profile
    base:
      apiVersion: eks.aws.upbound.io/v1beta1
      kind: FargateProfile
      metadata:
        name: xplane-fargate-profile
      spec:
        deletionPolicy: Delete
        forProvider:
          clusterNameRef:
            name:  xplane-eks-cluster
          podExecutionRoleArnRef:
            name: xplane-eks-fargate-pod-iam
          region: ap-southeast-1
          selector:
            - namespace: karpenter
              labels:
                app.kubernetes.io/name: karpenter
          subnetIdRefs:
            - name: xplane-private-subnet-1a
            - name: xplane-private-subnet-1b
            - name: xplane-private-subnet-1c
          tags:
            Name: xplane-fargate-profile
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: PatchSet
      patchSetName: region-patchset
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-fargate-profile"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-fargate-profile"
      toFieldPath: spec.forProvider.tags.Name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-eks-cluster"
      toFieldPath: spec.forProvider.clusterNameRef.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-fargate-pod-iam"
      toFieldPath: spec.forProvider.podExecutionRoleArnRef.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-private-subnet-1a"
      toFieldPath: spec.forProvider.subnetIdRefs[0].name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-private-subnet-1b"
      toFieldPath: spec.forProvider.subnetIdRefs[1].name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-private-subnet-1c"
      toFieldPath: spec.forProvider.subnetIdRefs[2].name
  - name: x-iam-karpenter-policy
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Policy
      metadata:
        name: xplane-karpenter-policy
      spec:
        deletionPolicy: Delete
        forProvider:
          tags:
            Name: xplane-karpenter-policy
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-karpenter-policy"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-karpenter-policy"
      toFieldPath: spec.forProvider.tags.Name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.awsAccountId
        - fromFieldPath: spec.name
        - fromFieldPath: spec.awsAccountId
        - fromFieldPath: spec.name
        strategy: string
        string: 
          fmt: |
            {
              "Statement": [
                {
                  "Action": [
                    "ssm:GetParameter",
                    "pricing:GetProducts",
                    "iam:TagInstanceProfile",
                    "iam:PassRole",
                    "iam:GetInstanceProfile",
                    "iam:CreateInstanceProfile",
                    "iam:AddRoleToInstanceProfile",
                    "ec2:TerminateInstances",
                    "ec2:RunInstances",
                    "ec2:DescribeSubnets",
                    "ec2:DescribeSpotPriceHistory",
                    "ec2:DescribeSecurityGroups",
                    "ec2:DescribeLaunchTemplates",
                    "ec2:DescribeInstances",
                    "ec2:DescribeInstanceTypes",
                    "ec2:DescribeInstanceTypeOfferings",
                    "ec2:DescribeImages",
                    "ec2:DescribeAvailabilityZones",
                    "ec2:DeleteLaunchTemplate",
                    "ec2:CreateTags",
                    "ec2:CreateLaunchTemplate",
                    "ec2:CreateFleet"
                  ],
                  "Effect": "Allow",
                  "Resource": "*",
                  "Sid": "Karpenter"
                },
                {
                  "Action": "ec2:TerminateInstances",
                  "Condition": {
                    "StringLike": {
                      "ec2:ResourceTag/Name": "*karpenter*"
                    }
                  },
                  "Effect": "Allow",
                  "Resource": "*",
                  "Sid": "ConditionalEC2Termination"
                },
                {
                  "Action": [
                    "sqs:ReceiveMessage",
                    "sqs:GetQueueUrl",
                    "sqs:GetQueueAttributes",
                    "sqs:DeleteMessage"
                  ],
                  "Effect": "Allow",
                  "Resource": "*",
                  "Sid": "KarpenterSQS"
                },
                {
                  "Action": "iam:PassRole",
                  "Effect": "Allow",
                  "Resource": "arn:aws:iam::%s:role/%s-xplane-eks-cluster",
                  "Sid": "PassNodeIAMRole"
                },
                {
                  "Action": "eks:DescribeCluster",
                  "Effect": "Allow",
                  "Resource": "arn:aws:eks:ap-southeast-1:%s:cluster/%s-xplane-eks-cluster",
                  "Sid": "EKSClusterEndpointLookup"
                }
              ],
              "Version": "2012-10-17"
            }
      toFieldPath: spec.forProvider.policy
      policy:
        fromFieldPath: Required
  - name: x-iam-karpenter
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      metadata:
        name: xplane-karpenter-iam
      spec:
        deletionPolicy: Delete
        forProvider:
          tags:
            Name: xplane-karpenter-iam
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-karpenter-iam"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-karpenter-iam"
      toFieldPath: spec.forProvider.tags.Name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.awsAccountId
        - fromFieldPath: status.oidcIssuer
        - fromFieldPath: status.oidcIssuer
        strategy: string
        string: 
          fmt: |
            {
              "Version": "2012-10-17",
              "Statement": [
                  {
                      "Effect": "Allow",
                      "Principal": {
                          "Federated": "arn:aws:iam::%s:oidc-provider/%s"
                      },
                      "Action": "sts:AssumeRoleWithWebIdentity",
                      "Condition": {
                          "StringEquals": {
                              "%s:sub": "system:serviceaccount:karpenter:karpenter"
                          }
                      }
                  }
              ]
            }
      toFieldPath: spec.forProvider.assumeRolePolicy
      policy:
        fromFieldPath: Required
  - name: x-iam-karpenter-policy-attachment
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      metadata:
        name: xplane-karpenter-policy-attachment
      spec:
        deletionPolicy: Delete
        forProvider:
          policyArnRef:
            name: xplane-karpenter-policy
          roleRef:
            name: xplane-karpenter-iam
        providerConfigRef:
          name: aws-provider
    patches:
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-karpenter-policy-attachment"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-karpenter-policy"
      toFieldPath: spec.forProvider.policyArnRef.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-karpenter-iam"
      toFieldPath: spec.forProvider.roleRef.name
  - name: x-iam-karpenter-node
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      metadata:
        name: xplane-karpenter-node-iam
      spec:
        deletionPolicy: Delete
        forProvider:
          assumeRolePolicy: |
            {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "ec2.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }
                ]
            }
          managedPolicyArns:
            - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
            - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
            - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
            - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
          tags:
            Name: xplane-karpenter-node-iam
            Owner: linus.yong
            Environment: sandbox
        providerConfigRef:
          name: aws-provider
    patches:
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-karpenter-node-iam"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: spec.name
        strategy: string
        string:
          fmt: "%s-xplane-karpenter-node-iam"
      toFieldPath: spec.forProvider.tags.Name